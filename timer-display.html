<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Display - Pulpit View</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            transition: background-color 0.5s ease;
        }

        .container {
            text-align: center;
            width: 100%;
            padding: 2rem;
            opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }

        .container.hidden {
            opacity: 0;
        }

        .time-display {
            font-family: 'Orbitron', monospace;
            font-size: clamp(8rem, 25vw, 28rem);
            font-weight: 900;
            line-height: 1;
            letter-spacing: -0.02em;
            margin-bottom: 2rem;
            text-shadow: 0 0 40px currentColor;
            transition: all 0.3s ease;
        }

        .status-text {
            font-size: clamp(2rem, 6vw, 5rem);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.9;
            margin-top: 1rem;
        }

        /* Color States */
        body.state-ready {
            background: #1a1a2e;
        }

        body.state-ready .time-display {
            color: #00ff9f;
        }

        body.state-running {
            background: #0f172a;
        }

        body.state-running .time-display {
            color: #22c55e;
        }

        body.state-warning {
            background: #1e1a0f;
        }

        body.state-warning .time-display {
            color: #fbbf24;
            animation: pulse-warning 2s ease-in-out infinite;
        }

        body.state-critical {
            background: #1a0f0f;
        }

        body.state-critical .time-display {
            color: #ef4444;
            animation: pulse-critical 1s ease-in-out infinite;
        }

        body.state-timeup {
            background: #dc2626;
            animation: flash 0.5s ease-in-out infinite;
        }

        body.state-timeup .time-display {
            color: #fff;
            font-size: clamp(6rem, 20vw, 20rem);
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(0.97); }
        }

        @keyframes flash {
            0%, 100% { background: #dc2626; }
            50% { background: #991b1b; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }

        .connection-status.hidden {
            opacity: 0;
        }

        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: #ef4444;
            animation: blink 1s ease-in-out infinite;
        }

        .status-dot.connected {
            background: #22c55e;
            animation: none;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .setup-message {
            font-size: clamp(1.5rem, 4vw, 3rem);
            color: #64748b;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Auto-hide indicator - subtle dot in bottom corner */
        .auto-hide-indicator {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: rgba(100, 116, 139, 0.3);
            transition: opacity 1.5s ease-in-out;
        }

        .auto-hide-indicator.active {
            background: rgba(34, 197, 94, 0.5);
        }

        .auto-hide-indicator.hidden {
            opacity: 0;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-direction: column;
            align-items: flex-end;
            opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }

        .control-panel.hidden {
            opacity: 0;
        }

        .control-btn {
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: #fff;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            user-select: none;
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .control-btn .indicator {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: #64748b;
            transition: background 0.2s ease;
        }

        .control-btn.active .indicator {
            background: #22c55e;
        }

        .control-btn .icon {
            font-size: 1rem;
        }

        /* Fullscreen styles */
        body:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }

        body:-moz-full-screen {
            width: 100%;
            height: 100%;
        }

        body:fullscreen {
            width: 100%;
            height: 100%;
        }

        /* Sound indicator */
        .sound-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(139, 92, 246, 0.9);
            border-radius: 50%;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .sound-indicator.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="state-ready">
    <div class="connection-status" id="connectionStatus">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="container" id="mainContainer">
        <div class="time-display" id="timeDisplay">--:--</div>
        <div class="status-text" id="statusMessage">Ready</div>
    </div>

    <div class="sound-indicator" id="soundIndicator">ðŸ””</div>

    <div class="auto-hide-indicator" id="autoHideIndicator"></div>
    
    <div class="control-panel" id="controlPanel">
        <button class="control-btn" id="fullscreenBtn" title="Toggle Fullscreen">
            <span class="icon">â›¶</span>
            <span>Fullscreen</span>
        </button>
        <button class="control-btn active" id="wakeLockBtn" title="Toggle Screen Wake Lock">
            <div class="indicator"></div>
            <span>Keep Awake</span>
        </button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAiG53GcvPpn6nUSRjHL0fZ9Zg8x7Gep7A",
            authDomain: "timer-7f805.firebaseapp.com",
            databaseURL: "https://timer-7f805-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timer-7f805",
            storageBucket: "timer-7f805.firebasestorage.app",
            messagingSenderId: "441965417573",
            appId: "1:441965417573:web:3436aa95d33177476a628c",
            measurementId: "G-QRJVHZTHVT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const timerRef = ref(database, 'timer');

        // DOM elements
        const timeDisplay = document.getElementById('timeDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const mainContainer = document.getElementById('mainContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const autoHideIndicator = document.getElementById('autoHideIndicator');
        const controlPanel = document.getElementById('controlPanel');
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const soundIndicator = document.getElementById('soundIndicator');
        const body = document.body;

        let countdownInterval = null;
        let endTime = null;
        let totalDuration = 0;
        let autoHideTimeout = null;
        let isVisible = true;
        let lastBeepTimestamp = null;

        // Wake Lock variables
        let wakeLock = null;
        let wakeLockEnabled = true;
        let wakeLockInterval = null;

        // Auto-hide configuration
        const AUTO_HIDE_CONFIG = {
            showDuration: 30000,
            hideDuration: 270000,
            finalMinutesThreshold: 120
        };

        // ============ SOUND GENERATION ============

        // Create AudioContext
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playBeep(frequency = 880, duration = 0.15) {
            return new Promise((resolve) => {
                const ctx = getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);

                setTimeout(resolve, duration * 1000);
            });
        }

        async function playBeepSequence(count = 3) {
            // Show visual indicator
            soundIndicator.classList.add('active');
            
            for (let i = 0; i < count; i++) {
                await playBeep(880, 0.15);
                if (i < count - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            // Hide visual indicator
            setTimeout(() => {
                soundIndicator.classList.remove('active');
            }, 300);
        }

        // Initialize audio context on first user interaction
        document.addEventListener('click', () => {
            if (!audioContext) {
                getAudioContext();
            }
        }, { once: true });

        // ============ WAKE LOCK FUNCTIONALITY ============
        
        async function requestWakeLock() {
            if (!wakeLockEnabled) return;

            try {
                if ('wakeLock' in navigator) {
                    if (wakeLock !== null) {
                        await wakeLock.release();
                    }

                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock activated');
                    
                    wakeLockBtn.classList.add('active');

                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                        wakeLock = null;
                        if (wakeLockEnabled) {
                            wakeLockBtn.classList.remove('active');
                        }
                    });
                } else {
                    console.warn('Wake Lock API not supported');
                }
            } catch (err) {
                console.error(`Wake Lock error: ${err.name}, ${err.message}`);
                wakeLock = null;
            }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('Wake Lock manually released');
                } catch (err) {
                    console.error('Error releasing wake lock:', err);
                }
            }
        }

        function startWakeLockRefresh() {
            stopWakeLockRefresh();
            
            wakeLockInterval = setInterval(async () => {
                if (wakeLockEnabled && (wakeLock === null || wakeLock.released)) {
                    console.log('Refreshing wake lock...');
                    await requestWakeLock();
                }
            }, 30000);
        }

        function stopWakeLockRefresh() {
            if (wakeLockInterval) {
                clearInterval(wakeLockInterval);
                wakeLockInterval = null;
            }
        }

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && wakeLockEnabled) {
                console.log('Page visible, requesting wake lock...');
                await requestWakeLock();
            }
        });

        wakeLockBtn.addEventListener('click', async () => {
            wakeLockEnabled = !wakeLockEnabled;
            
            if (wakeLockEnabled) {
                wakeLockBtn.classList.add('active');
                await requestWakeLock();
                startWakeLockRefresh();
            } else {
                wakeLockBtn.classList.remove('active');
                await releaseWakeLock();
                stopWakeLockRefresh();
            }
        });

        requestWakeLock();
        startWakeLockRefresh();

        // ============ FULLSCREEN FUNCTIONALITY ============

        function toggleFullscreen() {
            if (!document.fullscreenElement && 
                !document.webkitFullscreenElement && 
                !document.mozFullScreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        }

        fullscreenBtn.addEventListener('click', toggleFullscreen);

        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);

        function updateFullscreenButton() {
            const isFullscreen = !!(document.fullscreenElement || 
                                    document.webkitFullscreenElement || 
                                    document.mozFullScreenElement);
            
            fullscreenBtn.querySelector('span:last-child').textContent = 
                isFullscreen ? 'Exit Full' : 'Fullscreen';
        }

        // ============ FIREBASE & TIMER LOGIC ============

        onValue(timerRef, (snapshot) => {
            const data = snapshot.val();
            
            statusDot.classList.add('connected');
            statusText.textContent = 'Connected';

            if (!data) {
                resetDisplay();
                return;
            }

            const { duration, startTime, isRunning, reset, beepTrigger } = data;

            // Handle beep trigger
            if (beepTrigger && beepTrigger.timestamp !== lastBeepTimestamp) {
                lastBeepTimestamp = beepTrigger.timestamp;
                const count = beepTrigger.count || 3;
                playBeepSequence(count);
                
                // Temporarily show display if hidden
                if (!isVisible) {
                    showDisplay();
                    setTimeout(() => {
                        if (!isVisible) hideDisplay();
                    }, 3000);
                }
            }

            if (reset) {
                resetDisplay();
                return;
            }

            if (isRunning && startTime) {
                totalDuration = duration;
                startCountdown(duration, startTime);
            } else if (!isRunning) {
                clearInterval(countdownInterval);
                stopAutoHide();
                showDisplay();
                if (duration) {
                    displayTime(duration);
                    updateState('ready');
                    statusMessage.textContent = 'Ready';
                }
            }
        }, (error) => {
            console.error('Firebase error:', error);
            statusDot.classList.remove('connected');
            statusText.textContent = 'Disconnected';
        });

        function startCountdown(durationSeconds, startTimestamp) {
            clearInterval(countdownInterval);
            endTime = startTimestamp + (durationSeconds * 1000);

            scheduleAutoHide();

            countdownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));

                if (remaining === 0) {
                    clearInterval(countdownInterval);
                    stopAutoHide();
                    showDisplay();
                    showTimeUp();
                    playBeepSequence(5); // Play 5 beeps when time is up
                } else {
                    displayTime(remaining);
                    updateStateBasedOnTime(remaining);
                    
                    if (remaining <= AUTO_HIDE_CONFIG.finalMinutesThreshold) {
                        stopAutoHide();
                        showDisplay();
                        autoHideIndicator.classList.remove('active');
                    }
                }
            }, 100);
        }

        function scheduleAutoHide() {
            stopAutoHide();
            showDisplay();
            autoHideIndicator.classList.add('active');
            
            autoHideTimeout = setTimeout(() => {
                toggleDisplayVisibility();
            }, AUTO_HIDE_CONFIG.showDuration);
        }

        function toggleDisplayVisibility() {
            if (endTime) {
                const now = Date.now();
                const remaining = Math.ceil((endTime - now) / 1000);
                
                if (remaining <= AUTO_HIDE_CONFIG.finalMinutesThreshold) {
                    showDisplay();
                    autoHideIndicator.classList.remove('active');
                    return;
                }
            }

            if (isVisible) {
                hideDisplay();
                autoHideTimeout = setTimeout(() => {
                    toggleDisplayVisibility();
                }, AUTO_HIDE_CONFIG.hideDuration);
            } else {
                showDisplay();
                autoHideTimeout = setTimeout(() => {
                    toggleDisplayVisibility();
                }, AUTO_HIDE_CONFIG.showDuration);
            }
        }

        function showDisplay() {
            isVisible = true;
            mainContainer.classList.remove('hidden');
            connectionStatus.classList.remove('hidden');
            autoHideIndicator.classList.remove('hidden');
            controlPanel.classList.remove('hidden');
        }

        function hideDisplay() {
            isVisible = false;
            mainContainer.classList.add('hidden');
            connectionStatus.classList.add('hidden');
            autoHideIndicator.classList.add('hidden');
        }

        function stopAutoHide() {
            if (autoHideTimeout) {
                clearTimeout(autoHideTimeout);
                autoHideTimeout = null;
            }
            autoHideIndicator.classList.remove('active');
        }

        function displayTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timeDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            statusMessage.textContent = 'Time Remaining';
        }

        function updateStateBasedOnTime(seconds) {
            if (seconds > 120) {
                updateState('running');
            } else if (seconds > 60) {
                updateState('warning');
            } else {
                updateState('critical');
            }
        }

        function showTimeUp() {
            timeDisplay.textContent = 'TIME UP';
            statusMessage.textContent = '';
            updateState('timeup');
        }

        function updateState(state) {
            body.className = `state-${state}`;
        }

        function resetDisplay() {
            clearInterval(countdownInterval);
            stopAutoHide();
            showDisplay();
            timeDisplay.textContent = '--:--';
            statusMessage.textContent = 'Ready';
            updateState('ready');
            totalDuration = 0;
        }

        window.addEventListener('beforeunload', () => {
            releaseWakeLock();
            stopWakeLockRefresh();
        });
    </script>
</body>
</html>